name: Test Scriptified workflow
on:
  workflow_dispatch:
jobs:
  check-spack-yaml:
    name: Check spack.yaml
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          repository: access-nri/access-esm1.5
          fetch-depth: 0
          path: model

      - uses: actions/checkout@v4
        with:
          repository: access-nri/build-cd
          ref: 153-less-restrictive-projections-script
          path: cd

      - name: Validate ACCESS-NRI spack.yaml Restrictions
        uses: access-nri/schema/.github/actions/validate-with-schema@main
        with:
          schema-version: 3-0-0
          schema-location: au.org.access-nri/model/spack/environment/deployment
          data-location: ./model/spack.yaml

      - name: DBG - Check Model Version Modified
        id: version-modified
        working-directory: model
        run: |
          git status

      - name: Projection Version Matches
        # this step checks that the versions of the packages themselves match with the
        #  names of the projections, if they're given.
        # For example, access-om3@git.2023.12.12 matches with the
        #  modulefile access-om3/2023.12.12 (specifically, the version strings match)
        run: |
          ./cd/scripts/ci/projection-check.bash "./model/spack.yaml" "access-esm1p5"


      - name: DBG Generate Versions
        id: version
        # This step generates the release and prerelease version numbers.
        # The release is a general version number from the spack.yaml, looking the
        # same as a regular release build. Ex. 'access-om2@git.2024.01.1' -> '2024.01.1'
        # The prerelease looks like: `pr<pull request number>-<number of commits on this branch>`.
        # Ex. Pull Request #12 with 2 commits on branch -> `pr12-2`.
        working-directory: model
        run: |
          release=$(yq '${{ env.SPACK_YAML_MODEL_YQ }} | split("@git.") | .[1]' spack.yaml)"
          echo "$release"
          echo "release=$release" >> $GITHUB_OUTPUT

