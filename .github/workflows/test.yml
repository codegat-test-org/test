name: Test Workflow
on:
  workflow_call:
    inputs:
      additional-artifact-content-paths:
        type: string
        required: false
jobs:
  rsync:
    name: Rsync
    runs-on: ubuntu-latest
    env:
      TEST_OUTPUT_LOCAL_LOCATION: /opt/test-output
    steps:
      - name: Setup SSH
        id: ssh
        uses: access-nri/actions/.github/actions/setup-ssh@main
        with:
          hosts: |
            ${{ secrets.HOST }}
            ${{ secrets.HOST_DATA }}
          private-key: ${{ secrets.KEY }}

      - run: mkdir ${{ env.TEST_OUTPUT_LOCAL_LOCATION }}

      - name: rsync
        if: inputs.additional-artifact-content-paths != ''
        continue-on-error: true
        run: |
          while IFS= read -r content_path; do
            if [[ -n "$content_path" ]]; then
              echo "Going to rsync ${{ vars.ROOT_DIR }}/$content_path to ${{ env.TEST_OUTPUT_LOCAL_LOCATION }}"
              rsync --recursive --verbose -e 'ssh -i ${{ steps.ssh.outputs.private-key-path }}' \
                "${{ secrets.USER}}@${{ secrets.HOST_DATA }}:${{ vars.ROOT_DIR }}/$content_path" \
                ${{ env.TEST_OUTPUT_LOCAL_LOCATION }}
            fi
          done <<< "${{ inputs.additional-artifact-content-paths }}"

      - run: tree ${{ env.TEST_OUTPUT_LOCAL_LOCATION }}
