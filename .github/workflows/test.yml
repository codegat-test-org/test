name: Test Matrix Complex Excludes
on:
  workflow_dispatch:
jobs:
  pre-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
    - id: set-matrix
      run: |
        echo 'matrix=[{"template_value": "access3", "filepath": ".github/build-ci/manifests/access3/gcc.spack.yaml.j2"},{"template_value": "access3", "filepath": ".github/build-ci/manifests/access3/intel.spack.yaml.j2"},{"template_value": "access3-share", "filepath": ".github/build-ci/manifests/gcc.spack.yaml.j2"},{"template_value": "access3-share", "filepath": ".github/build-ci/manifests/intel.spack.yaml.j2"},{"template_value": "access-am3", "filepath": ".github/build-ci/manifests/access_am3/gcc.spack.yaml.j2"},{"template_value": "access-am3", "filepath": ".github/build-ci/manifests/access_am3/intel.spack.yaml.j2"},{"template_value": "access-cice", "filepath": ".github/build-ci/manifests/gcc.spack.yaml.j2"},{"template_value": "access-cice", "filepath": ".github/build-ci/manifests/intel.spack.yaml.j2"},{"template_value": "access-esm1p5", "filepath": ".github/build-ci/manifests/access_esm1p5/gcc.spack.yaml.j2"},{"template_value": "access-esm1p5", "filepath": ".github/build-ci/manifests/access_esm1p5/intel.spack.yaml.j2"},{"template_value": "access-esm1p6", "filepath": ".github/build-ci/manifests/access_esm1p6/gcc.spack.yaml.j2"},{"template_value": "access-esm1p6", "filepath": ".github/build-ci/manifests/access_esm1p6/intel.spack.yaml.j2"},{"template_value": "access-fms", "filepath": ".github/build-ci/manifests/gcc.spack.yaml.j2"},{"template_value": "access-fms", "filepath": ".github/build-ci/manifests/intel.spack.yaml.j2"},{"template_value": "access-generic-tracers", "filepath": ".github/build-ci/manifests/gcc.spack.yaml.j2"},{"template_value": "access-generic-tracers", "filepath": ".github/build-ci/manifests/intel.spack.yaml.j2"},{"template_value": "access-issm", "filepath": ".github/build-ci/manifests/access_issm/gcc.spack.yaml.j2"},{"template_value": "access-issm", "filepath": ".github/build-ci/manifests/access_issm/intel.spack.yaml.j2"},{"template_value": "access-mocsy", "filepath": ".github/build-ci/manifests/gcc.spack.yaml.j2"},{"template_value": "access-mocsy", "filepath": ".github/build-ci/manifests/intel.spack.yaml.j2"},{"template_value": "access-mom6", "filepath": ".github/build-ci/manifests/gcc.spack.yaml.j2"},{"template_value": "access-mom6", "filepath": ".github/build-ci/manifests/intel.spack.yaml.j2"},{"template_value": "access-om2", "filepath": ".github/build-ci/manifests/access_om2/gcc.spack.yaml.j2"},{"template_value": "access-om2", "filepath": ".github/build-ci/manifests/access_om2/intel.spack.yaml.j2"},{"template_value": "access-om2-bgc", "filepath": ".github/build-ci/manifests/access_om2_bgc/gcc.spack.yaml.j2"},{"template_value": "access-om2-bgc", "filepath": ".github/build-ci/manifests/access_om2_bgc/intel.spack.yaml.j2"},{"template_value": "access-om3", "filepath": ".github/build-ci/manifests/access_om3/gcc.spack.yaml.j2"},{"template_value": "access-om3", "filepath": ".github/build-ci/manifests/access_om3/intel.spack.yaml.j2"},{"template_value": "access-ram3", "filepath": ".github/build-ci/manifests/access_ram3/gcc.spack.yaml.j2"},{"template_value": "access-ram3", "filepath": ".github/build-ci/manifests/access_ram3/intel.spack.yaml.j2"},{"template_value": "access-test", "filepath": ".github/build-ci/manifests/access_test/gcc.spack.yaml.j2"},{"template_value": "access-test", "filepath": ".github/build-ci/manifests/access_test/intel.spack.yaml.j2"},{"template_value": "access-test-component", "filepath": ".github/build-ci/manifests/gcc.spack.yaml.j2"},{"template_value": "access-test-component", "filepath": ".github/build-ci/manifests/intel.spack.yaml.j2"},{"template_value": "access-triangle", "filepath": ".github/build-ci/manifests/gcc.spack.yaml.j2"},{"template_value": "access-triangle", "filepath": ".github/build-ci/manifests/intel.spack.yaml.j2"},{"template_value": "access-ww3", "filepath": ".github/build-ci/manifests/gcc.spack.yaml.j2"},{"template_value": "access-ww3", "filepath": ".github/build-ci/manifests/intel.spack.yaml.j2"},{"template_value": "ancoms-roms", "filepath": ".github/build-ci/manifests/gcc.spack.yaml.j2"},{"template_value": "ancoms-roms", "filepath": ".github/build-ci/manifests/intel.spack.yaml.j2"},{"template_value": "cable", "filepath": ".github/build-ci/manifests/cable/gcc.spack.yaml.j2"},{"template_value": "cable", "filepath": ".github/build-ci/manifests/cable/intel.spack.yaml.j2"},{"template_value": "cable", "filepath": ".github/build-ci/manifests/cable/library-intel.spack.yaml.j2"},{"template_value": "cable", "filepath": ".github/build-ci/manifests/cable/library-gcc.spack.yaml.j2"},{"template_value": "cice4", "filepath": ".github/build-ci/manifests/cice4/intel.spack.yaml.j2"},{"template_value": "cice5", "filepath": ".github/build-ci/manifests/gcc.spack.yaml.j2"},{"template_value": "cice5", "filepath": ".github/build-ci/manifests/intel.spack.yaml.j2"},{"template_value": "coastri-roms", "filepath": ".github/build-ci/manifests/gcc.spack.yaml.j2"},{"template_value": "coastri-roms", "filepath": ".github/build-ci/manifests/intel.spack.yaml.j2"},{"template_value": "datetime-fortran", "filepath": ".github/build-ci/manifests/gcc.spack.yaml.j2"},{"template_value": "datetime-fortran", "filepath": ".github/build-ci/manifests/intel.spack.yaml.j2"},{"template_value": "dummygrib", "filepath": ".github/build-ci/manifests/gcc.spack.yaml.j2"},{"template_value": "dummygrib", "filepath": ".github/build-ci/manifests/intel.spack.yaml.j2"},{"template_value": "fcm", "filepath": ".github/build-ci/manifests/gcc.spack.yaml.j2"},{"template_value": "fcm", "filepath": ".github/build-ci/manifests/intel.spack.yaml.j2"},{"template_value": "fiat", "filepath": ".github/build-ci/manifests/gcc.spack.yaml.j2"},{"template_value": "fiat", "filepath": ".github/build-ci/manifests/intel.spack.yaml.j2"},{"template_value": "fortranxml", "filepath": ".github/build-ci/manifests/gcc.spack.yaml.j2"},{"template_value": "fortranxml", "filepath": ".github/build-ci/manifests/intel.spack.yaml.j2"},{"template_value": "fre-nctools", "filepath": ".github/build-ci/manifests/gcc.spack.yaml.j2"},{"template_value": "fre-nctools", "filepath": ".github/build-ci/manifests/intel.spack.yaml.j2"},{"template_value": "gcom", "filepath": ".github/build-ci/manifests/gcc.spack.yaml.j2"},{"template_value": "gcom", "filepath": ".github/build-ci/manifests/intel.spack.yaml.j2"},{"template_value": "gcom4", "filepath": ".github/build-ci/manifests/gcc.spack.yaml.j2"},{"template_value": "gcom4", "filepath": ".github/build-ci/manifests/intel.spack.yaml.j2"},{"template_value": "issm", "filepath": ".github/build-ci/manifests/issm/spack.yaml.j2"},{"template_value": "libaccessom2", "filepath": ".github/build-ci/manifests/gcc.spack.yaml.j2"},{"template_value": "libaccessom2", "filepath": ".github/build-ci/manifests/intel.spack.yaml.j2"},{"template_value": "m1qn3", "filepath": ".github/build-ci/manifests/gcc.spack.yaml.j2"},{"template_value": "m1qn3", "filepath": ".github/build-ci/manifests/intel.spack.yaml.j2"},{"template_value": "mom5", "filepath": ".github/build-ci/manifests/gcc.spack.yaml.j2"},{"template_value": "mom5", "filepath": ".github/build-ci/manifests/intel.spack.yaml.j2"},{"template_value": "mppnccombine-fast", "filepath": ".github/build-ci/manifests/gcc.spack.yaml.j2"},{"template_value": "mppnccombine-fast", "filepath": ".github/build-ci/manifests/intel.spack.yaml.j2"},{"template_value": "nci-intel-oneapi-mkl", "filepath": ".github/build-ci/manifests/gcc.spack.yaml.j2"},{"template_value": "nci-intel-oneapi-mkl", "filepath": ".github/build-ci/manifests/intel.spack.yaml.j2"},{"template_value": "oasis3-mct", "filepath": ".github/build-ci/manifests/gcc.spack.yaml.j2"},{"template_value": "oasis3-mct", "filepath": ".github/build-ci/manifests/intel.spack.yaml.j2"},{"template_value": "um", "filepath": ".github/build-ci/manifests/gcc.spack.yaml.j2"},{"template_value": "um", "filepath": ".github/build-ci/manifests/intel.spack.yaml.j2"},{"template_value": "um7", "filepath": ".github/build-ci/manifests/um7/intel.spack.yaml.j2"}]' >> $GITHUB_OUTPUT

  matrix:
    needs: pre-matrix
    runs-on: ubuntu-latest
    strategy:
      matrix:
        package: ${{ fromJson(needs.pre-matrix.outputs.matrix) }}
        exclude:
          - package: {template_value: "access-om2"}
          - package: {template_value: "access-om3"}
          - package: {template_value: "access-esm1p5"}
          - package: {template_value: "access-esm1p6"}
          - package: {template_value: "access-am3"}
          - package: {template_value: "access-issm"}
          - package: {template_value: "access-test"}
    steps:
      - run: echo "template - ${{ matrix.package.template_value }}, fpath - ${{ matrix.package.filepath }}"
