on:
  workflow_dispatch:
jobs:
  failed-repro:
    name: Failed Reproduction Notifier
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Setup Issue Variables
        id: variables
        run: |
          config=access-om2-configs
          echo "config=$config" >> $GITHUB_OUTPUT
          echo "config-url=https://github.com/ACCESS-NRI/$config" >> $GITHUB_OUTPUT
          # model is just the config repo name without the '-configs' bit, so split it below with bash param expansion
          model=${config%-*}
          echo "model=$model" >> $GITHUB_OUTPUT
          echo "model-url=https://github.com/ACCESS-NRI/$model" >> $GITHUB_OUTPUT
          echo "tag-url=https://github.com/ACCESS-NRI/access-om2-configs/releases/tag/${{ needs.check-checksum.outputs.compared-checksum-version }}" >> GITHUB_OUTPUT
          echo "run-url=${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_OUTPUT

          cat $GITHUB_OUTPUT

      - name: Create issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
          BODY: |
            There was a failure of a monthly reproducibility check on `${{ github.repository }}`.
            Logs, checksums and other artifacts can be found at the Failed Run Log link below.

            Model: `${{ steps.variables.outputs.model }}`, found here: ${{ steps.variables.outputs.model-url }}
            Config Repo: `${{ steps.variables.outputs.config }}`, found here: ${{ steps.variables.outputs.config-url }}
            Config Tag Tested for Reproducibility: `nuffin`, found here: ${{ steps.variables.outputs.tag-url }}
            Failed Run Log: ${{ steps.variables.outputs.run-url }}
            Experiment Location (Gadi): `nowhere`

            Tagging @ACCESS-NRI/model-release
        run: |
          gh issue create \
            --title 'Scheduled Repro Check Failed for Config `thingy`' \
            --body '${{ env.BODY }}'